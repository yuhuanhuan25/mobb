var goods={};var useNum;function paying(){if($(".pay").html()=="立即购买"){$.ajax({type:"post",url:storeUrl+"/api/m/order/limit",xhrFields:{withCredentials:true},success:function(a){if(a.map.flag===0){$.ajax({type:"get",url:serviceUrl+"/m/scene/free/tpl/num?time="+new Date().getTime(),xhrFields:{withCredentials:true},success:function(b){useNum=b.obj}});if(goods.isCompanyTemp==1){if(a.type==2||a.type==21){layer.open({type:1,title:"",area:["600px",""],skin:"layui-layer-demo",closeBtn:0,shift:0,shade:[1,"rgba(0,0,0,.8)"],shadeClose:false,content:'<iframe id="eqx_pay" height="334px" style="width: 100%;display:block;line-height:0;font-size:0" src='+paymentUrl+' scrolling="no" frameborder="0"></iframe>'});window.addEventListener("message",onmessage)}else{layer.alert("您不是企业用户，无法使用该模板")}}else{layer.open({type:1,title:"",area:["600px",""],skin:"layui-layer-demo",closeBtn:0,shift:0,shade:[1,"rgba(0,0,0,.8)"],shadeClose:false,content:'<iframe id="eqx_pay" height="334px"  style="width: 100%;display:block;line-height:0;font-size:0" src='+paymentUrl+' scrolling="no" frameborder="0"></iframe>'});window.addEventListener("message",onmessage)}}else{layer.open({title:"",type:1,area:["466px",""],shift:0,shade:[1,"rgba(0,0,0,.8)"],shadeClose:false,closeBtn:0,content:'<div class="payTipsBox"><img style="margin-right:14px;float:left" src="/img/jingao.svg"><p class="text">您今日模板消费总额已超1000秀点，为保护您的账号安全，已冻结模板购买功能，明日会自动解封。<br/>如有疑问请咨询客服：010-56592226</p><span class="iknow">知道了</span></div>'});$(".iknow").click(function(){layer.closeAll()})}},error:function(){layer.open({title:"",type:1,area:["466px",""],shift:0,shade:[1,"rgba(0,0,0,.8)"],shadeClose:false,closeBtn:0,content:'<div class="payTipsBox"><img style="margin-right:14px;float:left" src="/img/jingao.svg"><p class="text">请重新登录</p><span class="iknow">知道了</span></div>'});$(".iknow").click(function(){layer.closeAll()})}})}else{layer.load(1,{shade:[1,"rgba(0,0,0,.8)"],closeBtn:1});setTimeout(function(){layer.closeAll("loading")},90000);$.ajax({type:"get",url:"api/product/"+goods.pId,success:function(a){if($(".breed").attr("kind")=="exemple"){goodsCopy(a.obj,2,null)}else{if($(".breed").attr("kind")=="picture"){goodsCopy(a.obj,1,null)}else{if($(".breed").attr("kind")=="font"){goodsCopy(a.obj,3,null,goods.license)}else{if($(".breed").attr("kind")=="music"&&$(".breed").attr("attrGroupId")==3){goodsCopy(a.obj,4,null)}else{if($(".breed").attr("kind")=="music"&&$(".breed").attr("attrGroupId")==5){goodsCopy(a.obj,5,null)}}}}}}})}}$.ajax({type:"get",url:userinfoUrl+"?time="+new Date().getTime(),xhrFields:{withCredentials:true},success:function(a){if(a.code===200){goods.eName=$(".e_name").text();goods.eSale=$(".e_sale").html();goods.ePrices=parseInt($(".e_price").html());goods.pId=$(".e_name").attr("productId");goods.kind=$(".e_name").attr("kind");goods.isCompanyTemp=$(".e_name").attr("isCompanyTemp");goods.sId=$(".e_name").attr("sourceId");goods.path=$(".e_name song").attr("src");goods.empower=$(".e_name").attr("empower");goods.license=$(".e_name").attr("empower");if($(".breed").attr("kind")=="font"){goods.ePrices=parseInt($(".comptent>span:nth-of-type(1)").attr("price"));var c=sessionStorage.getItem("empower");if(c===1){$(".comptent>span:nth-of-type(1)").css("border","none");$(".comptent>span:nth-of-type(2)").css("border","solid 1px red");$(".e_price").text($(".comptent>span:nth-of-type(2)").attr("price"));goods.ePrices=parseInt($(".comptent>span:nth-of-type(2)").attr("price"))}}var b=localStorage.getItem("paying");if(b){localStorage.removeItem("paying");paying()}}}});$(".pay").click(function(){goods.eName=$(".e_name").text();goods.eSale=$(".e_sale").html();goods.ePrices=parseInt($(".e_price").html());goods.pId=$(".e_name").attr("productId");goods.kind=$(".e_name").attr("kind");goods.isCompanyTemp=$(".e_name").attr("isCompanyTemp");goods.sId=$(".e_name").attr("sourceId");goods.path=$(".e_name song").attr("src");goods.empower=$(".e_name").attr("empower");goods.license=$(".e_name").attr("empower");$.ajax({type:"get",url:userinfoUrl+"?time="+new Date().getTime(),xhrFields:{withCredentials:true},success:function(a){if(a.code===200){paying()}else{$("#header_one").css("display","block");$("#header_two").css("display","none");login();localStorage.setItem("paying","true")}}})});function onmessage(h){var j=h.data;if(typeof j==="string"){j=JSON.parse(j)}var f=document.getElementById("eqx_pay");if(j.msgType=="close"){$(".layui-layer-shade,.layui-layer").remove();window.removeEventListener("message",onmessage)}if(j.msgType=="resize"){$("#eqx_pay").attr("height",j.iframeHeight);var c=$(window).height();var k=(c-j.iframeHeight)/2;if(k<0){k=0}$("#eqx_pay").parent().parent().css("top",k)}if(j.msgType=="successInfo"){var g={productId:goods.pId,sId:goods.sId,totalFee:j.data.obj.orderAmount,outOrderId:j.data.obj.merchantOrderNo,channel:"PC"};var i=JSON.stringify(g);$.ajax({type:"post",url:storeUrl+"api/m/order/save",contentType:"application/json",dataType:"json",xhrFields:{withCredentials:true},data:i,success:function(a){var e=a.obj;if(a.code===200){$(".layui-layer-shade,.layui-layer").remove();window.removeEventListener("message",onmessage);layer.load(1,{shade:[1,"rgba(0,0,0,.8)"],closeBtn:1});setTimeout(function(){layer.closeAll("loading")},90000);if($(".breed").attr("kind")=="exemple"){goodsCopy(e,2,a.map.orderId)}if($(".breed").attr("kind")=="picture"){goodsCopy(e,1,a.map.orderId)}if($(".breed").attr("kind")=="font"){goodsCopy(e,3,a.map.orderId,goods.license)}if($(".breed").attr("kind")=="music"&&$(".breed").attr("attrGroupId")==3){goodsCopy(e,4,a.map.orderId)}if($(".breed").attr("kind")=="music"&&$(".breed").attr("attrGroupId")==5){goodsCopy(e,5,a.map.orderId)}}else{layer.alert("购买失败")}}})}if(j.msgType=="errorInfo"){layer.alert("购买失败")}if(j.msgType=="done"){var d;var b="api/m/order/sign";if($(".breed").attr("kind")=="exemple"){d=1}else{if($(".breed").attr("kind")=="font"){d=4;if(goods.empower&&goods.empower==1){b="api/m/order/sign_business"}}else{if($(".breed").attr("kind")=="picture"){d=2}else{if($(".breed").attr("kind")=="music"){d=3}}}}f.contentWindow.postMessage({price:goods.ePrices,orderAppId:paymentAppid,userCount:useNum,buyItems:[{id:goods.pId,name:goods.eName,price:goods.ePrices,count:1,total:goods.ePrices*1,type:d}],signUrl:storeUrl+b},paymentUrl)}}function goodsCopy(f,b,d,c){var a={};var e;if(b==2){a={id:f.id,type:f.tplType,price:f.price,orderId:d,prodType:b,pageMode:f.page_mode,source:1};e='<div class="paySuccessBox"><p class="psbone" style="overflow:hidden"><img style="margin-right:14px;float:left" src="/img/yes.svg"><span>模板购买成功！</span></p><p class="psbtwo">该模板已保存至“我的场景”中</p><p class="psbthree" style="margin-top:45px;"><a class="usenow">立即使用</a><a href="/cats-2.html" class="closepsbox">我再逛逛</a></p></div>'}else{if(b==1){a={id:f.id,price:f.price,name:f.title,path:f.authedPath,orderId:d,prodType:b,source:1};e='<div class="paySuccessBox"><p class="psbone" style="overflow:hidden"><img style="margin-right:14px;float:left" src="/img/yes.svg"><span>图片购买成功！</span></p><p class="psbtwo">该图片已保存至编辑器素材内“我的购买”中</p><p class="psbthree" style="margin-top:45px;"><a class="usenow" href="http://www.eqxiu.com/site/main">立即使用</a><a href="/cats-1.html" class="closepsbox">我再逛逛</a></p></div>'}else{if(b==4){a={id:f.id,price:f.price,name:f.title,path:f.path,orderId:d,prodType:b,source:1};e='<div class="paySuccessBox"><p class="psbone" style="overflow:hidden"><img style="margin-right:14px;float:left" src="/img/yes.svg"><span>音乐购买成功！</span></p><p class="psbtwo">该音乐已保存至编辑器素材内“我的购买”中</p><p class="psbthree" style="margin-top:45px;"><a class="usenow" href="http://www.eqxiu.com/site/main">立即使用</a><a href="/cats-4.html" class="closepsbox">我再逛逛</a></p></div>'}else{if(b==5){a={id:f.id,price:f.price,name:f.title,path:f.path,orderId:d,prodType:4,musicType:4,source:1};e='<div class="paySuccessBox"><p class="psbone" style="overflow:hidden"><img style="margin-right:14px;float:left" src="/img/yes.svg"><span>音乐购买成功！</span></p><p class="psbtwo">该音乐已保存至编辑器素材内“我的购买”中</p><p class="psbthree" style="margin-top:45px;"><a class="usenow" href="http://www.eqxiu.com/site/main">立即使用</a><a href="/cats-4.html" class="closepsbox">我再逛逛</a></p></div>'}else{if(b==3){if(c==0){a={id:f.id,price:f.price,license:c,orderId:d,prodType:b,source:1}}else{a={id:f.id,price:f.business_price,license:c,orderId:d,prodType:b,source:1}}e='<div class="paySuccessBox"><p class="psbone" style="overflow:hidden"><img style="margin-right:14px;float:left" src="/img/yes.svg"><span>字体购买成功！</span></p><p class="psbtwo">该字体已保存至编辑器素材内“我的购买”中</p><p class="psbthree" style="margin-top:45px;"><a class="usenow" href="http://www.eqxiu.com/site/main">立即使用</a><a href="/cats-3.html" class="closepsbox">我再逛逛</a></p></div>'}}}}}$.ajax({type:"post",url:storeUrl+"api/m/asyncOrderCallback/callback",xhrFields:{withCredentials:true},data:a,success:function(h){var i;var g=0;if(h.code==200){i=setInterval(function(){g++;$.ajax({type:"post",url:storeUrl+"api/m/asyncOrderCallback/isOrderCallbackSuccessById",data:{id:h.map.id},xhrFields:{withCredentials:true},success:function(j){if(j.map.status==1){clearInterval(i);$(".layui-layer-shade,.layui-layer").remove();if(b==2){layer.open({title:"",type:1,area:["450px",""],shift:0,closeBtn:0,shade:[1,"rgba(0,0,0,.8)"],shadeClose:false,content:e});$(".usenow").click(function(){location.href=editorUrl+j.map.callBackId+"?i=1"})}else{layer.open({title:"",type:1,area:["450px",""],shift:0,closeBtn:0,shade:[1,"rgba(0,0,0,.8)"],shadeClose:false,content:e})}point(event,f)}else{if(j.map.status==2||j.map.status==3){clearInterval(i);$(".layui-layer-shade,.layui-layer").remove();layer.alert(j.map.error)}}}});if(g>10){clearInterval(i);$(".layui-layer-shade,.layui-layer").remove();layer.alert("操作超时",{title:"温馨提示"})}},1000)}else{$(".layui-layer-shade,.layui-layer").remove();layer.alert(h.map.error)}}})};